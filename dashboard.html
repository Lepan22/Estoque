<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Novo Layout</title>
  <link rel="stylesheet" href="assets/novo_style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

  <button class="menu-toggle" id="menuToggleBtn">â˜°</button>

  <div class="sidebar" id="sidebarMenu">
    <h2>LePan</h2>
    <ul>
      <li><a href="#" class="active">Dashboard</a></li>
      <li><a href="comercial_estimativa.html">ðŸ“ˆ GestÃ£o de Estimativas</a></li> <!-- Link para nova pÃ¡gina -->
      <li><a href="assets/relatorio.html">ðŸ“Š RelatÃ³rios</a></li>
      <li><a href="assets/produtos.html">ðŸ“¦ Produtos</a></li>
      <li><a href="lista_clientes.html">ðŸ‘¥ Clientes</a></li>
      <li><a href="evento.html">ðŸ“… Eventos</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="container-principal">
      <h1>Dashboard</h1>

      <div class="kpi-cards">
        <div class="kpi"><h2 id="clientesAtivos">0</h2><span>Clientes Ativos</span></div>
        <div class="kpi"><h2 id="receitaMes">R$ 0,00</h2><span>Receita do MÃªs (PDV)</span></div>
        <div class="kpi"><h2 id="lucroMes">R$ 0,00</h2><span>Lucro do MÃªs</span></div>
        <div class="kpi"><h2 id="eventosMes">0</h2><span>Eventos no MÃªs</span></div>
      </div>

      <div class="charts-grid">
        <div class="chart-container">
          <canvas id="chartVendas"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartLucro"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartPerda"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="chartEventos"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Script do menu toggle
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const sidebarMenu = document.getElementById('sidebarMenu');
    if (menuToggleBtn && sidebarMenu) {
        menuToggleBtn.addEventListener('click', () => {
            sidebarMenu.classList.toggle('active');
        });
    }

    // Script original do dashboard (Firebase, Charts, etc.)
    const firebaseConfig = {
      databaseURL: "https://controleestoquelepan-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function formatar(valor) {
      return "R$ " + (valor || 0).toFixed(2).replace('.', ',');
    }

    // Modificado para usar vendaPDV para receita e lucro consistentemente
    function agruparPorMes(eventos) {
      const mapa = {};
      eventos.forEach(ev => {
        if (ev.status !== "finalizado") return;
        const mes = ev.data?.slice(0, 7); // formato YYYY-MM
        if (!mapa[mes]) {
          mapa[mes] = { receita: 0, perda: 0, lucro: 0, eventos: 0 }; // estimativa removida daqui
        }
        const a = ev.analise || {};
        const receita = parseFloat(a.vendaPDV) || 0; // USAR VENDA PDV
        const perda = parseFloat(a.valorPerda) || 0;
        const cmv = parseFloat(a.cmvTotal) || 0;
        const equipe = parseFloat(a.custoEquipe) || 0;
        const logistica = parseFloat(a.custoLogistica) || 0;
        const lucro = receita - cmv - equipe - logistica; // Lucro baseado na receita (vendaPDV)

        mapa[mes].receita += receita;
        mapa[mes].perda += perda;
        mapa[mes].lucro += lucro;
        mapa[mes].eventos += 1;
      });

      const ordenado = Object.keys(mapa).sort().map(mes => ({
        mes,
        ...mapa[mes]
      }));
      return ordenado;
    }

    // Modificado para usar vendaPDV para receita e lucro consistentemente
    function atualizarKPIs(eventos, clientes) {
      const ativos = Object.values(clientes || {}).filter(c => c.statusCliente === "Ativo").length;
      document.getElementById("clientesAtivos").textContent = ativos;

      const hoje = new Date();
      const mesAtual = hoje.toISOString().slice(0, 7);

      let receitaDoMes = 0, lucroDoMes = 0, eventosNoMes = 0;

      eventos.forEach(ev => {
        if (ev.status !== "finalizado") return;
        if ((ev.data || "").startsWith(mesAtual)) {
          const a = ev.analise || {};
          const vendaPDVAtual = parseFloat(a.vendaPDV) || 0;
          receitaDoMes += vendaPDVAtual;
          const cmv = parseFloat(a.cmvTotal) || 0;
          const equipe = parseFloat(a.custoEquipe) || 0;
          const log = parseFloat(a.custoLogistica) || 0;
          lucroDoMes += vendaPDVAtual - cmv - equipe - log; // Lucro baseado na vendaPDV
          eventosNoMes += 1;
        }
      });

      document.getElementById("receitaMes").textContent = formatar(receitaDoMes);
      document.getElementById("lucroMes").textContent = formatar(lucroDoMes);
      document.getElementById("eventosMes").textContent = eventosNoMes;
    }

    function criarGrafico(id, label, labels, dataset) {
      const chartElement = document.getElementById(id);
      if (!chartElement) {
          console.error(`Elemento do grÃ¡fico com ID '${id}' nÃ£o encontrado.`);
          return null;
      }
      const ctx = chartElement.getContext('2d');
      // Destruir grÃ¡fico existente se houver para evitar sobreposiÃ§Ã£o
      if (chartElement.chartInstance) {
          chartElement.chartInstance.destroy();
      }
      chartElement.chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: dataset },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: label }
          }
        }
      });
      return chartElement.chartInstance;
    }

    function criarLinha(id, label, labels, dados, cor = 'green') {
      const chartElement = document.getElementById(id);
      if (!chartElement) {
          console.error(`Elemento do grÃ¡fico com ID '${id}' nÃ£o encontrado.`);
          return null;
      }
      const ctx = chartElement.getContext('2d');
      if (chartElement.chartInstance) {
          chartElement.chartInstance.destroy();
      }
      chartElement.chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data: dados,
            borderColor: cor,
            backgroundColor: cor + '33',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: label }
          }
        }
      });
      return chartElement.chartInstance;
    }

    async function carregarDashboard() {
      try {
        const [eventosSnap, clientesSnap, estimativasResponse] = await Promise.all([
          db.ref("eventos").once("value"),
          db.ref("clientes").once("value"),
          fetch('/api/estimativas') // Busca da API Flask
        ]);

        const eventosData = eventosSnap.val() || {};
        const clientesData = clientesSnap.val() || {};
        
        if (!estimativasResponse.ok) {
            console.error("Erro ao buscar estimativas da API:", estimativasResponse.statusText);
            // Tratar erro, talvez mostrar mensagem para o usuÃ¡rio
            return; // Interromper se as estimativas nÃ£o puderem ser carregadas
        }
        const estimativasApi = await estimativasResponse.json();

        const eventos = Object.values(eventosData);
        const clientes = clientesData;

        const mesesComDadosReais = agruparPorMes(eventos);

        const estimativasAgrupadasPorMes = {};
        estimativasApi.forEach(est => {
            const mesAno = est.data_estimativa; // Formato "YYYY-MM"
            estimativasAgrupadasPorMes[mesAno] = (estimativasAgrupadasPorMes[mesAno] || 0) + parseFloat(est.valor_estimado);
        });

        const todosOsMeses = new Set();
        mesesComDadosReais.forEach(m => todosOsMeses.add(m.mes));
        Object.keys(estimativasAgrupadasPorMes).forEach(m => todosOsMeses.add(m));
        const labelsGlobais = Array.from(todosOsMeses).sort();

        const dataEstimativaParaGrafico = labelsGlobais.map(mes => estimativasAgrupadasPorMes[mes] || 0);
        
        const receitaRealPorMesMap = {};
        mesesComDadosReais.forEach(m => { receitaRealPorMesMap[m.mes] = m.receita; });
        const dataReceitaRealParaGrafico = labelsGlobais.map(mes => receitaRealPorMesMap[mes] || 0);

        atualizarKPIs(eventos, clientes);

        criarGrafico("chartVendas", "Estimativa vs Venda (PDV)", labelsGlobais, [
          {
            label: "Estimativa",
            data: dataEstimativaParaGrafico,
            backgroundColor: "#ffc107" // Amarelo para estimativa
          },
          {
            label: "Venda Real (PDV)",
            data: dataReceitaRealParaGrafico,
            backgroundColor: "#007bff"
          }
        ]);

        const lucroPorMesMap = {};
        mesesComDadosReais.forEach(m => { lucroPorMesMap[m.mes] = m.lucro; });
        const dataLucro = labelsGlobais.map(mes => lucroPorMesMap[mes] || 0);

        const perdaPorMesMap = {};
        mesesComDadosReais.forEach(m => { perdaPorMesMap[m.mes] = m.perda; });
        const dataPerda = labelsGlobais.map(mes => perdaPorMesMap[mes] || 0);
        
        const eventosPorMesMap = {};
        mesesComDadosReais.forEach(m => { eventosPorMesMap[m.mes] = m.eventos; });
        const dataEventos = labelsGlobais.map(mes => eventosPorMesMap[mes] || 0);

        criarLinha("chartLucro", "Lucro por MÃªs", labelsGlobais, dataLucro, "#28a745");
        criarLinha("chartPerda", "Perda por MÃªs", labelsGlobais, dataPerda, "#dc3545");
        criarLinha("chartEventos", "Eventos por MÃªs", labelsGlobais, dataEventos, "#17a2b8");

      } catch (error) {
          console.error("Erro ao carregar o dashboard:", error);
          // Exibir uma mensagem de erro mais amigÃ¡vel para o usuÃ¡rio no dashboard se necessÃ¡rio
      }
    }

    carregarDashboard();
  </script>
</body>
</html>

