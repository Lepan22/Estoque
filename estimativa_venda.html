<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estimativa de Venda</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="p-4">
  <h2>Estimativa de Venda</h2>

  <div class="row my-3">
    <div class="col-md-6">
      <label for="eventoSelect" class="form-label">Selecione os nomes de eventos:</label>
      <select id="eventoSelect" class="form-select" multiple></select>
    </div>
    <div class="col-md-2 align-self-end">
      <button class="btn btn-primary" onclick="gerarRelatorio()">Gerar Relatório</button>
    </div>
    <div class="col-md-2 align-self-end">
      <button class="btn btn-success" onclick="exportarExcel()">Exportar Excel</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle text-center" id="tabelaRelatorio">
      <thead class="table-light">
        <tr id="cabecalho">
          <th>Produto</th>
        </tr>
      </thead>
      <tbody id="corpoTabela"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      databaseURL: "https://controleestoquelepan-default-rtdb.firebaseio.com/",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function carregarNomesEventos() {
      const snapshot = await db.ref("controle").once("value");
      const nomesSet = new Set();
      snapshot.forEach(child => {
        const nome = child.val().nomeEvento;
        if (nome) nomesSet.add(nome);
      });
      const select = document.getElementById("eventoSelect");
      [...nomesSet].sort().forEach(nome => {
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        select.appendChild(opt);
      });
    }

    function calcularQuantidadeVendida(prod) {
      return (prod.enviado || 0) - ((prod.assado || 0) + (prod.perda || 0) + (prod.congelado || 0));
    }

    async function gerarRelatorio() {
      const select = document.getElementById("eventoSelect");
      const nomesSelecionados = Array.from(select.selectedOptions).map(opt => opt.value);
      if (nomesSelecionados.length === 0) return;

      const [controleSnap, produtosSnap] = await Promise.all([
        db.ref("controle").once("value"),
        db.ref("produtos").once("value")
      ]);

      const produtosData = produtosSnap.val() || {};
      const eventos = {};
      controleSnap.forEach(child => {
        const item = child.val();
        const nome = item.nomeEvento;
        if (nomesSelecionados.includes(nome)) {
          if (!eventos[nome] || new Date(item.data) > new Date(eventos[nome].data)) {
            eventos[nome] = item;
          }
        }
      });

      const produtoMap = {};
      for (const nome of nomesSelecionados) {
        const evento = eventos[nome];
        if (!evento || !evento.produtos) continue;

        for (const [id, prod] of Object.entries(evento.produtos)) {
          const nomeProduto = prod.nome || "Sem nome";
          if (!produtoMap[nomeProduto]) {
            produtoMap[nomeProduto] = {
              nome: nomeProduto,
              porEvento: {},
              quantidadePorCaixa: produtosData[id]?.quantidadePorCaixa || ""
            };
          }
          produtoMap[nomeProduto].porEvento[nome] = calcularQuantidadeVendida(prod);
        }
      }

      // Construção da tabela
      const tabela = document.getElementById("tabelaRelatorio");
      const thead = document.getElementById("cabecalho");
      const tbody = document.getElementById("corpoTabela");
      thead.innerHTML = "<th>Produto</th>";
      nomesSelecionados.forEach(nome => {
        const th = document.createElement("th");
        th.textContent = nome;
        thead.appendChild(th);
      });
      thead.innerHTML += `
        <th>Total</th>
        <th>Quantidade por Caixa</th>
        <th>Pedido</th>
      `;
      tbody.innerHTML = "";

      Object.values(produtoMap).forEach(prod => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="text-start">${prod.nome}</td>`;
        let total = 0;

        nomesSelecionados.forEach(nome => {
          const valor = prod.porEvento[nome] || 0;
          total += valor;
          tr.innerHTML += `<td>${valor}</td>`;
        });

        const idLinha = `linha-${prod.nome.replace(/\s+/g, "_")}`;
        tr.innerHTML += `<td class="total" data-total="${total}">${total}</td>`;
        tr.innerHTML += `
          <td>
            <input type="number" class="form-control form-control-sm caixa-input" data-id="${idLinha}" value="${prod.quantidadePorCaixa}" min="1">
          </td>
          <td class="pedido" id="${idLinha}-pedido"></td>
        `;

        tbody.appendChild(tr);
      });

      calcularPedidos();
      document.querySelectorAll(".caixa-input").forEach(input => {
        input.addEventListener("input", calcularPedidos);
      });
    }

    function calcularPedidos() {
      document.querySelectorAll("tr").forEach(tr => {
        const totalTd = tr.querySelector(".total");
        const input = tr.querySelector(".caixa-input");
        const pedidoTd = tr.querySelector(".pedido");
        if (totalTd && input && pedidoTd) {
          const total = parseFloat(totalTd.dataset.total) || 0;
          const porCaixa = parseFloat(input.value) || 0;
          const pedido = porCaixa > 0 ? (total / porCaixa).toFixed(2) : "-";
          pedidoTd.textContent = pedido;
        }
      });
    }

    function exportarExcel() {
      const wb = XLSX.utils.book_new();
      const tabela = document.getElementById("tabelaRelatorio");
      const ws = XLSX.utils.table_to_sheet(tabela);
      XLSX.utils.book_append_sheet(wb, ws, "EstimativaVenda");
      XLSX.writeFile(wb, "EstimativaVenda.xlsx");
    }

    window.onload = carregarNomesEventos;
  </script>
</body>
</html>
