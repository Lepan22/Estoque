<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Estimativas Comerciais</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .form-section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 5px; background-color: #fafafa;}
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="month"], input[type="number"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button { 
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px;}
        button:hover { background-color: #0056b3; }
        .button-edit { background-color: #ffc107; }
        .button-edit:hover { background-color: #e0a800; }
        .button-delete { background-color: #dc3545; }
        .button-delete:hover { background-color: #c82333; }
        .hidden { display: none; }
        #error-message { color: red; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestão de Estimativas Comerciais</h1>

        <div id="error-message"></div>

        <div class="form-section">
            <h2 id="form-title">Adicionar Nova Estimativa</h2>
            <form id="estimativa-form">
                <input type="hidden" id="estimativa-id">
                <div>
                    <label for="data-estimativa">Data (Mês/Ano):</label>
                    <input type="month" id="data-estimativa" name="data-estimativa" required>
                </div>
                <div>
                    <label for="categoria">Categoria:</label>
                    <input type="text" id="categoria" name="categoria" required>
                </div>
                <div>
                    <label for="valor-estimado">Valor Estimado (R$):</label>
                    <input type="number" id="valor-estimado" name="valor-estimado" step="0.01" required>
                </div>
                <button type="submit" id="submit-button">Salvar Estimativa</button>
                <button type="button" id="cancel-edit-button" class="hidden">Cancelar Edição</button>
            </form>
        </div>

        <h2>Estimativas Cadastradas</h2>
        <table id="estimativas-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Data (Mês/Ano)</th>
                    <th>Categoria</th>
                    <th>Valor Estimado (R$)</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        const apiUrl = "."; // API na mesma origem, prefixo /api/estimativas já está no blueprint
        const form = document.getElementById("estimativa-form");
        const tableBody = document.querySelector("#estimativas-table tbody");
        const estimativaIdInput = document.getElementById("estimativa-id");
        const dataEstimativaInput = document.getElementById("data-estimativa");
        const categoriaInput = document.getElementById("categoria");
        const valorEstimadoInput = document.getElementById("valor-estimado");
        const formTitle = document.getElementById("form-title");
        const submitButton = document.getElementById("submit-button");
        const cancelEditButton = document.getElementById("cancel-edit-button");
        const errorMessageDiv = document.getElementById("error-message");

        async function fetchEstimativas() {
            errorMessageDiv.textContent = "";
            try {
                const response = await fetch(`${apiUrl}/api/estimativas`);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                const estimativas = await response.json();
                tableBody.innerHTML = ""; // Limpar tabela
                estimativas.forEach(est => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${est.id}</td>
                        <td>${est.data_estimativa}</td>
                        <td>${est.categoria}</td>
                        <td>${parseFloat(est.valor_estimado).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
                        <td>
                            <button class="button-edit" onclick="editEstimativa(${est.id}, '${est.data_estimativa}', '${est.categoria}', ${est.valor_estimado})">Editar</button>
                            <button class="button-delete" onclick="deleteEstimativa(${est.id})">Excluir</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Erro ao buscar estimativas:", error);
                errorMessageDiv.textContent = `Erro ao buscar estimativas: ${error.message}. Verifique o console para mais detalhes.`;
            }
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            errorMessageDiv.textContent = "";
            const id = estimativaIdInput.value;
            const dataEstimativa = dataEstimativaInput.value; // YYYY-MM
            const categoria = categoriaInput.value;
            const valorEstimado = parseFloat(valorEstimadoInput.value);

            if (!dataEstimativa || !categoria || isNaN(valorEstimado)) {
                errorMessageDiv.textContent = "Por favor, preencha todos os campos corretamente.";
                return;
            }

            const method = id ? "PUT" : "POST";
            const url = id ? `${apiUrl}/api/estimativas/${id}` : `${apiUrl}/api/estimativas`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data_estimativa: dataEstimativa, categoria, valor_estimado: valorEstimado })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || `Erro HTTP: ${response.status}`);
                }
                form.reset();
                estimativaIdInput.value = "";
                formTitle.textContent = "Adicionar Nova Estimativa";
                submitButton.textContent = "Salvar Estimativa";
                cancelEditButton.classList.add("hidden");
                fetchEstimativas();
            } catch (error) {
                console.error("Erro ao salvar estimativa:", error);
                errorMessageDiv.textContent = `Erro ao salvar estimativa: ${error.message}`;
            }
        });

        function editEstimativa(id, data, categoria, valor) {
            estimativaIdInput.value = id;
            dataEstimativaInput.value = data; // Formato YYYY-MM já é compatível com input type="month"
            categoriaInput.value = categoria;
            valorEstimadoInput.value = valor;
            formTitle.textContent = "Editar Estimativa";
            submitButton.textContent = "Atualizar Estimativa";
            cancelEditButton.classList.remove("hidden");
            window.scrollTo(0, 0); // Rolar para o topo para ver o formulário
        }

        cancelEditButton.addEventListener("click", () => {
            form.reset();
            estimativaIdInput.value = "";
            formTitle.textContent = "Adicionar Nova Estimativa";
            submitButton.textContent = "Salvar Estimativa";
            cancelEditButton.classList.add("hidden");
            errorMessageDiv.textContent = "";
        });

        async function deleteEstimativa(id) {
            if (!confirm("Tem certeza que deseja excluir esta estimativa?")) return;
            errorMessageDiv.textContent = "";
            try {
                const response = await fetch(`${apiUrl}/api/estimativas/${id}`, { method: "DELETE" });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || `Erro HTTP: ${response.status}`);
                }
                fetchEstimativas();
            } catch (error) {
                console.error("Erro ao excluir estimativa:", error);
                errorMessageDiv.textContent = `Erro ao excluir estimativa: ${error.message}`;
            }
        }

        // Carregar estimativas ao iniciar a página
        fetchEstimativas();
    </script>
</body>
</html>
