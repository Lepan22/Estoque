<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Evento</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="container">
    <h1>Detalhes do Evento</h1>
    <div id="eventoInfo"></div>
    <h3>Itens:</h3>
    
    <table id="itens-tabela">
      <thead>
        <tr>
          <th class="col-nome">Nome</th>
          <th class="col-quantidade">Quantidade</th>
          <th class="col-editavel">Assado</th>
          <th class="col-editavel">Congelado</th>
          <th class="col-editavel">Perdido</th>
        </tr>
      </thead>
      <tbody id="itens-tbody">
        <tr><td colspan="5">Carregando itens...</td></tr>
      </tbody>
    </table>

    <div class="button-container" style="margin-top: 20px;">
      <button id="finalizarEventoBtn">Finalizar Evento e Salvar Alterações</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp }               from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    //===== CONFIG FIREBASE =====
    const firebaseConfig = { /* seus dados */ };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    //===== CAPTURA URL =====
    const params   = new URLSearchParams(window.location.search);
    const eventId  = params.get("id");
    const editKey  = params.get("editKey");
    const MY_TOKEN = "MINHA_CHAVE_SECRETA"; // deve bater com o index.html

    const isEditable = (editKey === MY_TOKEN);
    const refEvento  = ref(db, `eventos/${eventId}`);
    const itensBody  = document.getElementById("itens-tbody");
    const btnFinal   = document.getElementById("finalizarEventoBtn");

    if (!eventId) {
      alert("ID do Evento não fornecido na URL.");
      window.location.href = "index.html";
    }

    // função que habilita/desabilita interface
    function toggleEditMode() {
      // mostra ou oculta botão de salvar
      btnFinal.style.display = isEditable ? "inline-block" : "none";
      // inputs
      document.querySelectorAll("#itens-tbody input")
              .forEach(i => i.disabled = !isEditable);
    }

    // carrega dados do evento
    function carregarDados() {
      get(refEvento).then(snap => {
        if (!snap.exists()) {
          alert("Evento não encontrado.");
          location.href = "index.html";
          return;
        }
        const ev    = snap.val();
        const itens = Array.isArray(ev.itens) ? ev.itens : [];

        // header
        document.getElementById("eventoInfo").innerHTML = `
          <p><strong>Nome:</strong> ${ev.nome || "—"}</p>
          <p><strong>Data:</strong> ${ev.data || "—"}</p>
          <p><strong>Responsável:</strong> ${ev.responsavel || "—"}</p>
        `;

        // tabela
        itensBody.innerHTML = "";
        if (itens.length === 0) {
          itensBody.innerHTML = `<tr><td colspan="5">Nenhum item registrado.</td></tr>`;
        } else {
          itens.forEach((item, idx) => {
            const tr = document.createElement("tr");
            tr.setAttribute("data-item-index", idx);

            const nomeExib       = item.nomeItem ?? item.nome ?? "—";
            const quantidadeExib = item.quantidade ?? item.qtd ?? "—";

            tr.innerHTML = `
              <td>${nomeExib}</td>
              <td>${quantidadeExib}</td>
              <td><input type="number" name="assado"    value="${item.assado    ?? 0}" min="0"></td>
              <td><input type="number" name="congelado" value="${item.congelado ?? 0}" min="0"></td>
              <td><input type="number" name="perdido"   value="${item.perdido   ?? 0}" min="0"></td>
            `;
            itensBody.appendChild(tr);
          });
        }

        // logo após renderizar
        toggleEditMode();
      }).catch(err => {
        console.error("Erro ao carregar evento:", err);
        itensBody.innerHTML = `<tr><td colspan="5">Erro ao carregar itens.</td></tr>`;
      });
    }

    // salvar / finalizar
    btnFinal.addEventListener("click", () => {
      btnFinal.disabled    = true;
      btnFinal.textContent = "Salvando…";

      get(refEvento).then(snap => {
        const evOrig  = snap.val();
        const itensO  = Array.isArray(evOrig.itens) ? evOrig.itens : [];
        const novos   = [];

        document.querySelectorAll("#itens-tbody tr[data-item-index]")
          .forEach(tr => {
            const idx = +tr.getAttribute("data-item-index");
            if (isNaN(idx) || !itensO[idx]) return;
            const orig = itensO[idx];
            const assado    = parseInt(tr.querySelector('input[name="assado"]').value, 10)    || 0;
            const congelado = parseInt(tr.querySelector('input[name="congelado"]').value, 10) || 0;
            const perdido   = parseInt(tr.querySelector('input[name="perdido"]').value, 10)   || 0;
            novos.push({ ...orig, assado, congelado, perdido });
          });

        update(refEvento, { itens: novos, status: "finalizado" })
          .then(() => {
            alert("Alterações salvas e evento finalizado!");
            toggleEditMode();
          })
          .catch(err => {
            console.error("Erro ao salvar:", err);
            alert("Falha ao salvar. Veja console.");
            btnFinal.disabled    = false;
            btnFinal.textContent = "Finalizar Evento e Salvar Alterações";
          });
      });
    });

    // init
    carregarDados();
  </script>
</body>
</html>
