
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Performance por Evento</title>
  <style>
    body { margin: 20px; font-family: Arial, sans-serif; font-size: 13px; }
    h1 { font-size: 20px; margin-bottom: 20px; }
    .filtros { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
    thead { background-color: #f0f0f0; }
    .totais { font-weight: bold; background-color: #f9f9f9; }
  </style>
</head>
<body>

<h1>Performance por Evento</h1>

<div class="filtros">
  <label for="eventoSelect"><strong>Nome do Evento:</strong></label>
  <select id="eventoSelect"></select>
</div>

<table id="resumoFinanceiro">
  <thead>
    <tr>
      <th>Data</th>
      <th>Venda PDV</th>
      <th>Diferença</th>
      <th>Perda</th>
      <th>Resultado</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5">Selecione um evento para visualizar os dados.</td></tr>
  </tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  databaseURL: "https://controleestoquelepan-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const selectEvento = document.getElementById("eventoSelect");
const tbody = document.querySelector("#resumoFinanceiro tbody");

function formatar(valor) {
  return "R$ " + parseFloat(valor || 0).toFixed(2).replace(".", ",");
}
function formatarData(iso) {
  return iso ? iso.split("-").reverse().join("/") : "–";
}

function carregarEventos() {
  db.ref("eventos").once("value").then(snap => {
    const eventos = snap.val() || {};
    const eventosFinalizados = Object.values(eventos).filter(e => e.status === "finalizado" && e.nome);
    
    const nomes = [...new Set(Object.entries(eventos)
      .filter(([id, e]) => e.status === "finalizado" && e.nome)
      .map(([id, e]) => e.nome))].sort();
    selectEvento.innerHTML = "<option value=''>Selecione</option>" + nomes.map(n => `<option value="${n}">${n}</option>`).join("");
    
    selectEvento.addEventListener("change", () => filtrar(eventos));
  });
}

function filtrar(eventos) {
  const nome = selectEvento.value;
  if (!nome) return;

  const filtrados = Object.values(eventos).filter(ev => ev.nome === nome && ev.status === "finalizado");
  tbody.innerHTML = "";

  filtrados.sort((a, b) => a.data.localeCompare(b.data)).forEach(ev => {
    const a = ev.analise || {};
    const vendaPDV = parseFloat(a.vendaPDV) || 0;
    const valorVenda = parseFloat(a.valorVenda) || 0;
    const perda = parseFloat(a.valorPerda) || 0;
    const equipe = parseFloat(a.custoEquipe) || 0;
    const log = parseFloat(a.custoLogistica) || 0;
    const cmv = parseFloat(a.cmvTotal) || 0;
    const resultado = vendaPDV - cmv - equipe - log;
    const diferenca = vendaPDV - valorVenda;

    const tr = document.createElement("tr");
    tr.innerHTML = \`
      <td>\${formatarData(ev.data)}</td>
      <td>\${formatar(vendaPDV)}</td>
      <td>\${formatar(diferenca)}</td>
      <td>\${formatar(perda)}</td>
      <td>\${formatar(resultado)}</td>
    \`;
    tbody.appendChild(tr);
  });
}

document.addEventListener("DOMContentLoaded", carregarEventos);
</script>
</body>
</html>
